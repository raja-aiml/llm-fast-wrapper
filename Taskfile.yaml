version: "3"

env:
  DATABASE_URL: "postgres://llm:llm@localhost:5432/llmlogs?sslmode=disable"

tasks:
  default:
    desc: "ğŸ“‹ List available tasks"
    cmds:
      - task --list

  dev:
    desc: "ğŸš€ Start the API (default: Fiber)"
    cmds:
      - go run ./cmd/main.go serve --fiber

  dev:gin:
    desc: "ğŸš€ Start the API using Gin"
    cmds:
      - go run ./cmd/main.go serve --gin

  test:
    desc: "ğŸ§ª Run all unit tests"
    cmds:
      - go test -cover ./...

  test:ginkgo:
    desc: "ğŸ§ª Run Ginkgo unit tests"
    cmds:
      - ginkgo -r --cover --randomize-all --fail-on-pending

  client:run:
    desc: "ğŸ’¬ Run streaming client"
    cmds:
      - python3 client/cli.py --prompt "hello world"

  docker:up:
    desc: "ğŸ³ Start observability infra (PostgreSQL, Prometheus, Jaeger, Splunk)"
    dir: docker
    cmds:
      - docker compose up -d

  docker:down:
    desc: "ğŸ§¼ Stop and remove containers"
    dir: docker
    cmds:
      - docker compose down

  docker:ps:
    desc: "ğŸ” Show container status"
    dir: docker
    cmds:
      - docker compose ps

  docker:build:
    desc: "ğŸ› ï¸ Build production Docker image"
    cmds:
      - docker build -t llm-fast-wrapper .

  docker:run:
    desc: "ğŸ§ª Run app from Docker (Fiber)"
    cmds:
      - docker run --rm -p 8080:8080 llm-fast-wrapper serve --fiber

  kind:up:
    desc: "ğŸ“¦ Create a local kind cluster"
    cmds:
      - bash scripts/kind-setup.sh

  kind:down:
    desc: "ğŸ—‘ï¸ Cleanup kind cluster and Helm release"
    cmds:
      - bash scripts/cleanup.sh
